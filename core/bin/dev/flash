#!/usr/bin/env bash

# flash

# Usage:
# $ flash -d <device> - b <binary file>
# Example: flash -d stm32f072rb -b program.bin

# Get arguments
while getopts d:b: option
do
    case "${option}"
    in
	d) device=${OPTARG};;
	b) bin=${OPTARG};;
    esac
done

# Check that bin argument exists
if ! [ -f "${bin}" ]; then
    echo "Error: Binary file '${bin}' does not exist!"
    exit 1
fi

# Check that device argument exists
if [ "${device}" == "stm32f072rb" ]; then
    echo "Flashing ${device}..."
else
    echo "Error: Device '${device}' is not supported yet!"
    exit 1
fi

# Check if jlink is installed
if ! [ -x "$(command -v JLinkExe)" ]; then
  echo 'Error: JLink is not installed!!!' >&2
  exit 1
fi

# Create script
conf=/tmp/bin_flash_jlink_conf
echo "si 1" > ${conf}
echo "device ${device}" >> ${conf}
echo "speed 4000" >> ${conf}
echo "erase" >> ${conf}
echo "loadbin $(realpath ${bin}), 0x00" >> ${conf}
echo "r" >> ${conf}
echo "g" >> ${conf}
echo "exit" >> ${conf}

# Program it
JLinkExe -CommanderScript ${conf}
#cat ${conf}
rm ${conf}

exit 0
