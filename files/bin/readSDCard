#!/bin/bash

NAME=$1
DEVICE="/dev/mmcblk0"

# Check if device exists
if ! [ -e ${DEVICE} ] ; then
    echo "Device ${DEVICE} not found"
    exit 1
fi

# Check file argument
if [ -z ${NAME} ] ; then
    echo "Please provide image filename"
    exit 2
fi

# Check if image file exists
if [ -f ${NAME} ]; then
    echo "${NAME} allready exists!!!"
    exit 3
fi

# Unmount SD Card
echo "Unmounting SD Card"
umount ${DEVICE}*

# Read from SD Card
echo "Reading SD Card from ${DEVICE}"
sudo dd bs=4M if=${DEVICE} of=${NAME} status=progress

# Compress it
echo "Compressing image"
gzip -9 -k ${NAME}
echo "OK"

# Compress it
echo "Verifying image"
gzip -t ${NAME}.gz
echo "OK"

echo "Finished"
